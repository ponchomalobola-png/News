<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Juvi Chat</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKXMFN74FW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FKXMFN74FW');
  </script>
  <style>
    button {
      touch-action: manipulation;
    }
    #footer {
      background: #eeeeee;
      color: #333;
      font-size: 0.75em;
      text-align: center;
      padding: 6px 10px;
      border-top: 1px solid #ccc;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: sans-serif;
      background: #e5ddd5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #075e54;
      color: #fff;
      padding: 10px 0 30px;
      text-align: center;
      font-weight: bold;
      font-size: 1em;
      position: relative;
    }
    #live-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      animation: pulse 1.5s infinite;
      z-index: 999;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    #ticker {
      background: #25d366;
      color: #000;
      font-size: 0.8em;
      padding: 5px 10px;
      white-space: nowrap;
      overflow: hidden;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
    #ticker span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 15s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    #chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 75%;
      word-wrap: break-word;
      font-size: 0.9em;
      position: relative;
    }
    .user {
      background: #dcf8c6;
      align-self: flex-end;
    }
    .bot {
      background: #f0f0f0;
      align-self: flex-start;
    }
    .timestamp {
      font-size: 0.7em;
      color: #555;
      margin-top: 2px;
      text-align: right;
    }
    .date-divider {
      text-align: center;
      font-size: 0.75em;
      color: #666;
      margin: 10px 0;
      padding: 5px;
      background: #f0f0f0;
      border-radius: 10px;
    }
    #input-area {
      display: flex;
      align-items: center;
      padding: 8px;
      background: #f7f7f7;
      gap: 8px;
    }
    #user-input {
      flex: 1;
      padding: 10px 14px;
      border: none;
      border-radius: 20px;
      font-size: 0.9em;
      background: #fff;
      box-shadow: 0 0 2px rgba(0,0,0,0.2);
    }
    #button-group {
      display: flex;
      gap: 6px;
    }
    .chat-button {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      font-size: 1.2em;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .chat-button:hover {
      transform: scale(1.1);
    }
    #send-btn {
      background: #25d366;
    }
    #clear-btn {
      background: #d32f2f;
    }
    .quick-reply {
      display: inline-block;
      margin: 2px;
      padding: 4px 8px;
      background: #075e54;
      color: white;
      border-radius: 12px;
      font-size: 0.8em;
      cursor: pointer;
    }
    .quick-reply:hover {
      background: #054d44;
    }
  </style>
</head>
<body>
  <div id="live-badge">LIVE</div>
  <header>
    üéì Juvi Assistant
    <div id="ticker"><span id="headline-text">Welcome! ‚Ä¢ Grade 12 Practice Zone available ‚Ä¢ Game Zone for breaks ‚Ä¢ Latest news updates</span></div>
  </header>
  <div id="chat-box"></div>
  <div id="input-area">
    <input type="text" id="user-input" placeholder="Ask about news, practice, games, or site help..." />
    <div id="button-group">
      <button id="send-btn" class="chat-button" onclick="sendMessage()">üì´</button>
      <button id="clear-btn" class="chat-button" onclick="clearAllMessages()">üö´</button>
    </div>
  </div>

  <script>
    // Global variables
    let chatWasCleared = false;
    let lastDate = '';
    let userContext = {
      userType: '', // 'student', 'matric_rewrite', 'young_learner', 'general'
      interests: [],
      lastActivity: '',
      mood: 'neutral'
    };

    // DOM elements
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');

    // Educational headlines for ticker
    const headlines = [
      "Welcome! ‚Ä¢ Grade 12 Practice Zone available ‚Ä¢ Game Zone for breaks ‚Ä¢ Latest news updates",
      "New Math modules added to Practice Zone ‚Ä¢ Study smarter!",
      "Game Zone: Educational games for stress relief and learning",
      "Matric rewrite candidates: Access past papers and study guides",
      "Young learners: Fun educational games available in Game Zone",
      "Stay updated with latest educational news and trends"
    ];
    let headlineIndex = 0;

    // Enter key support
    userInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    function rotateHeadlines() {
      document.getElementById('headline-text').textContent = headlines[headlineIndex];
      headlineIndex = (headlineIndex + 1) % headlines.length;
    }
    setInterval(rotateHeadlines, 8000);

    function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      
      const now = new Date();
      insertDateDivider(now);
      appendMessage(text, 'user', now);
      saveToHistory(text, 'user', now);
      userInput.value = '';
      
      // Update user context
      updateUserContext(text);
      
      // Disable buttons during processing
      document.getElementById('send-btn').disabled = true;
      document.getElementById('clear-btn').disabled = true;
      
      setTimeout(() => {
        const reply = generateSmartReply(text);
        appendMessage(reply, 'bot', new Date());
        saveToHistory(reply, 'bot', new Date());
        
        // Re-enable buttons
        document.getElementById('send-btn').disabled = false;
        document.getElementById('clear-btn').disabled = false;
      }, 400);
    }

    function updateUserContext(input) {
      const lower = input.toLowerCase();
      
      // Detect user type
      if (lower.includes('grade 12') || lower.includes('practice') || lower.includes('study')) {
        userContext.userType = 'student';
        userContext.interests.push('academic');
      }
      if (lower.includes('matric') || lower.includes('rewrite')) {
        userContext.userType = 'matric_rewrite';
        userContext.interests.push('exam_prep');
      }
      if (lower.includes('game') || lower.includes('play') || lower.includes('fun')) {
        userContext.interests.push('games');
      }
      if (lower.includes('news') || lower.includes('update')) {
        userContext.interests.push('news');
      }
      if (lower.includes('stress') || lower.includes('tired') || lower.includes('break')) {
        userContext.mood = 'stressed';
      }
      
      userContext.lastActivity = new Date().toISOString();
    }

    function generateSmartReply(input) {
      const lower = input.toLowerCase();
      
      // Smart intent detection with context awareness
      const intent = detectIntent(lower);
      
      switch(intent) {
        case 'greeting':
          return getGreetingResponse();
        case 'news_request':
          return getNewsResponse();
        case 'practice_help':
          return getPracticeResponse();
        case 'game_request':
          return getGameResponse();
        case 'stress_relief':
          return getStressResponse();
        case 'site_navigation':
          return getNavigationResponse(lower);
        case 'study_help':
          return getStudyAdvice();
        case 'unknown':
          return getFallbackResponse();
      }
    }

    function detectIntent(input) {
      if (/(hello|hi|hey|greetings)/i.test(input)) return 'greeting';
      if (/(news|update|latest|current)/i.test(input)) return 'news_request';
      if (/(practice|study|module|grade 12|matric|exam)/i.test(input)) return 'practice_help';
      if (/(game|play|fun|break)/i.test(input)) return 'game_request';
      if (/(stress|tired|overwhelmed|break|rest)/i.test(input)) return 'stress_relief';
      if (/(where|navigate|go to|find|location)/i.test(input)) return 'site_navigation';
      if (/(help|advice|tips|how to)/i.test(input)) return 'study_help';
      return 'unknown';
    }

    function getGreetingResponse() {
      const greetings = [
        "üëã Hello! I'm your Juvi assistant. I can help you with news, Grade 12 practice, games, or site navigation!",
        "üéì Welcome back! Ready to learn something new today?",
        "üìö Hey there! Need help with studies, news, or maybe a fun break?"
      ];
      return greetings[Math.floor(Math.random() * greetings.length)] + 
             " <span class='quick-reply' onclick=\"userInput.value='news'\">üì∞ News</span>" +
             " <span class='quick-reply' onclick=\"userInput.value='practice'\">üìñ Practice</span>" +
             " <span class='quick-reply' onclick=\"userInput.value='games'\">üéÆ Games</span>";
    }

    function getNewsResponse() {
      return "üì∞ <strong>Latest Educational News:</strong><br>" +
             "‚Ä¢ New curriculum updates for 2025<br>" +
             "‚Ä¢ Digital learning tools now available<br>" +
             "‚Ä¢ Matric results show improvement trends<br><br>" +
             "Stay informed with our news section! " +
             "<span class='quick-reply' onclick=\"userInput.value='practice zone'\">Switch to Practice</span>";
    }

    function getPracticeResponse() {
      if (userContext.userType === 'matric_rewrite') {
        return "üìö <strong>Matric Rewrite Support:</strong><br>" +
               "‚Ä¢ Past exam papers (2018-2024)<br>" +
               "‚Ä¢ Subject-specific study guides<br>" +
               "‚Ä¢ Progress tracking dashboard<br>" +
               "‚Ä¢ Expert tutor recommendations<br><br>" +
               "You've got this! Need a break? " +
               "<span class='quick-reply' onclick=\"userInput.value='games'\">Take a break</span>";
      }
      
      return "üìñ <strong>Grade 12 Practice Zone:</strong><br>" +
             "‚Ä¢ Interactive modules for all subjects<br>" +
             "‚Ä¢ Real-time progress tracking<br>" +
             "‚Ä¢ Quick quizzes and assessments<br>" +
             "‚Ä¢ Peer discussion forums<br><br>" +
             "Ready to practice? " +
             "<span class='quick-reply' onclick=\"userInput.value='math practice'\">Math</span>" +
             " <span class='quick-reply' onclick=\"userInput.value='science practice'\">Science</span>";
    }

    function getGameResponse() {
      return "üéÆ <strong>Game Zone - Learning Made Fun!</strong><br>" +
             "‚Ä¢ Educational puzzles and brain games<br>" +
             "‚Ä¢ Memory and focus training<br>" +
             "‚Ä¢ Subject-based learning games<br>" +
             "‚Ä¢ Stress-relief activities<br><br>" +
             "Perfect for breaks! " +
             "<span class='quick-reply' onclick=\"userInput.value='back to practice'\">Return to Study</span>" +
             " <span class='quick-reply' onclick=\"userInput.value='news'\">Check News</span>";
    }

    function getStressResponse() {
      return "ü´Ç <strong>Take a Breather!</strong><br>" +
             "I understand studying can be intense. Here's what I recommend:<br>" +
             "‚Ä¢ Short 5-min break in Game Zone<br>" +
             "‚Ä¢ Quick mindfulness exercise<br>" +
             "‚Ä¢ Switch to light news reading<br>" +
             "‚Ä¢ Hydrate and stretch<br><br>" +
             "<span class='quick-reply' onclick=\"userInput.value='games'\">Quick Game Break</span>" +
             " <span class='quick-reply' onclick=\"userInput.value='light news'\">Light Reading</span>";
    }

    function getNavigationResponse(input) {
      if (input.includes('practice') || input.includes('study')) {
        return "üìç Taking you to <strong>Practice Zone</strong>...<br>" +
               "You'll find subject modules, past papers, and progress tracking there!";
      }
      if (input.includes('game') || input.includes('play')) {
        return "üéÆ Redirecting to <strong>Game Zone</strong>...<br>" +
               "Have fun while learning! Remember to return to studies refreshed.";
      }
      if (input.includes('news')) {
        return "üì∞ Navigating to <strong>News Section</strong>...<br>" +
               "Stay updated with the latest educational trends and news!";
      }
      
      return "üó∫Ô∏è <strong>Site Navigation:</strong><br>" +
             "‚Ä¢ Practice Zone - Study materials and exercises<br>" +
             "‚Ä¢ Game Zone - Educational games and breaks<br>" +
             "‚Ä¢ News Section - Latest updates and articles<br>" +
             "‚Ä¢ Profile - Track your progress and goals";
    }

    function getStudyAdvice() {
      const tips = [
        "üí° <strong>Study Tip:</strong> Try the Pomodoro technique - 25min study, 5min break!",
        "üéØ <strong>Pro Tip:</strong> Practice active recall by testing yourself regularly!",
        "üìù <strong>Advice:</strong> Create a study schedule and stick to it consistently!"
      ];
      return tips[Math.floor(Math.random() * tips.length)] +
             "<br><span class='quick-reply' onclick=\"userInput.value='practice zone'\">Start Practicing</span>";
    }

    function getFallbackResponse() {
      return "ü§î I'm not sure I understand. I can help you with:<br>" +
             "‚Ä¢ üì∞ Latest news and updates<br>" +
             "‚Ä¢ üìñ Grade 12 practice materials<br>" +
             "‚Ä¢ üéÆ Educational games and breaks<br>" +
             "‚Ä¢ üó∫Ô∏è Site navigation assistance<br><br>" +
             "What would you like to explore?";
    }

    function appendMessage(text, sender, time) {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      msg.innerHTML = `${text}<div class="timestamp">${formatTime(time)}</div>`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function insertDateDivider(date) {
      const today = formatDate(date);
      if (today !== lastDate) {
        const divider = document.createElement('div');
        divider.className = 'date-divider';
        divider.textContent = today;
        chatBox.appendChild(divider);
        lastDate = today;
      }
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(date) {
      return date.toLocaleDateString([], { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
    }

    function saveToHistory(text, sender, time) {
      try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        history.push({ text, sender, time: time.getTime() });
        localStorage.setItem('chatHistory', JSON.stringify(history));
      } catch (error) {
        console.error('Error saving to history:', error);
      }
    }

    function loadHistory() {
      try {
        const now = Date.now();
        const week = 7 * 24 * 60 * 60 * 1000;
        let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        history = history.filter(msg => now - msg.time < week);
        localStorage.setItem('chatHistory', JSON.stringify(history));
        lastDate = '';
        history.forEach(msg => {
          const date = new Date(msg.time);
          insertDateDivider(date);
          appendMessage(msg.text, msg.sender, date);
        });
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    function clearAllMessages() {
      try {
        // Clear all messages from localStorage
        localStorage.setItem('chatHistory', JSON.stringify([]));
        
        // Clear the chat interface
        chatBox.innerHTML = '';
        lastDate = '';
        
        // Reset user context
        userContext = {
          userType: '',
          interests: [],
          lastActivity: '',
          mood: 'neutral'
        };
        
        // Add a fresh welcome message
        setTimeout(() => {
          const welcomeMsg = getGreetingResponse();
          appendMessage(welcomeMsg, 'bot', new Date());
          saveToHistory(welcomeMsg, 'bot', new Date());
        }, 500);
      } catch (error) {
        console.error('Error clearing messages:', error);
      }
    }

    // Initialize with welcome message if first visit
    function initializeChat() {
      const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
      if (history.length === 0) {
        setTimeout(() => {
          const welcomeMsg = getGreetingResponse();
          appendMessage(welcomeMsg, 'bot', new Date());
          saveToHistory(welcomeMsg, 'bot', new Date());
        }, 1000);
      }
    }

    // IndexedDB setup
    let db;
    try {
      const request = indexedDB.open("JuviData", 1);
      request.onerror = () => console.log("IndexedDB failed");
      request.onsuccess = () => {
        db = request.result;
      };
      request.onupgradeneeded = (event) => {
        db = event.target.result;
        db.createObjectStore("user_preferences", { autoIncrement: true });
      };
    } catch (error) {
      console.error('IndexedDB error:', error);
    }

    // Initialize chat
    loadHistory();
    initializeChat();
  </script>
  <footer id="footer">
    ¬© 2025 Juvenile Corner ChatBot ‚Ä¢ Grade 12 Practice ‚Ä¢ Game Zone ‚Ä¢ News Updates
  </footer>
</body>
</html>